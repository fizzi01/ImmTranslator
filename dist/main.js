/**
 * @license
 * RESTRICTED USE LICENSE
 * Copyright © 2025 Federico Izzi.
 * All rights reserved.
 * This source code and all its components are the exclusive property of Federico Izzi and are protected by copyright laws and international treaties. Any reproduction, copying, distribution, modification, decompilation, reverse engineering, or any other form of use, in whole or in part, is strictly prohibited without the prior written consent of the owner.
 * Unauthorized use of this code constitutes a violation of copyright and will be subject to legal action under applicable laws. No rights to exploit or license this code, whether express or implied, are granted except through a written agreement signed by Federico Izzi.
 * 
 * For permission requests or further inquiries, please contact:
 * 
 * - rugiade_cavigliere_2h@icloud.com
 * - https://github.com/fizzi01
 * 
 **/
!function(){let t,e,n=!1,o=!1,a=!0,r=[],i=[];const l="function"==typeof crypto.randomUUID;function c(){return l?crypto.randomUUID():function t(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(t=>{const e=15&crypto.getRandomValues(new Uint8Array(1))[0];return("x"===t?e:3&e|8).toString(16)}))}()}class d{static pauseTranslation(){n=!0}static resumeTranslation(){n=!1}static cancelTranslation(){o=!0}static translationStatus(t){a=t}static sleep(t){return new Promise((e=>setTimeout(e,t)))}static yieldControl(){return new Promise((t=>requestAnimationFrame(t)))}static decodeHTMLEntities(t){return(new DOMParser).parseFromString(t,"text/html").documentElement.textContent}static normalize(t){return t.replace(/[^\p{L}\p{N}]/gu,"")}static base64ToUint8Array(t){const e=atob(t),n=new Uint8Array(new ArrayBuffer(e.length));for(let t=0;t<e.length;t++)n[t]=e.charCodeAt(t);return n}static getTextNodes(t){const e=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,{acceptNode:function(t){return t.parentNode&&["SCRIPT","STYLE","NOSCRIPT"].includes(t.parentNode.tagName)?NodeFilter.FILTER_REJECT:t.nodeValue.trim()?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}}),n=[];let o;for(;o=e.nextNode();)n.push(o);return n}static async checkPaused(){for(;n&&!o;)await d.sleep(100);if(o)throw new Error("Translation canceled.")}static isCancelled(){return o}static storeOriginalTextNodes(){if(r.length>0)return;const t=d.getTextNodes(document.body);for(const e of t)r.push({node:e,text:e.nodeValue})}static storeTranslationNodes(){i.length>0&&(i=[]);const t=d.getTextNodes(document.body);for(const e of t)i.push({node:e,text:e.nodeValue})}static observeCanvasResize(t){window._canvasObservers||(window._canvasObservers=new WeakMap),window._canvasObservers.has(t)&&window._canvasObservers.get(t).disconnect(),t._observerPaused=!1;const e=new ResizeObserver((()=>{t._observerPaused||S.debouncedUpdate(t,null,null,!0)}));e.observe(t),window._canvasObservers.set(t,e)}static pauseCanvasObserver(t){return t._observerPaused=!0,!(!window._canvasObservers||!window._canvasObservers.has(t))&&(window._canvasObservers.get(t).disconnect(),!0)}static resumeCanvasObserver(t){if(window._canvasObservers&&window._canvasObservers.has(t)){return window._canvasObservers.get(t).observe(t),setTimeout((()=>{t._observerPaused=!1}),50),!0}return!1}static resetTranslation(t=(()=>{}),n=(()=>{})){if(a){e||d.storeTranslationNodes(),n("Reset",!1);for(const t of r)t.node.nodeValue=t.text;document.querySelectorAll(".ocr-box").forEach((t=>{t.style.display="none"})),t("Translation Reset","success"),a=!1}else{for(const t of i)t.text&&(t.node.nodeValue=t.text);document.querySelectorAll(".ocr-box").forEach((t=>{t.style.display="flex",S.adjustFontSize(t)})),t("Translation Restored","success"),a=!0}}}class p{execute(t){throw new Error("Metodo execute() non implementato.")}}class u extends p{constructor(t){super(),this.pdfExporter=t}async execute(t,e){try{await this.pdfExporter.export(t,e)}catch(t){throw t}}}class m extends p{constructor(){super()}async execute(t,e){try{return await f.processPage(t,e)}catch(t){throw t}}}class h extends p{constructor(t){super(),this.imageExporter=t}async execute(t,e){try{await this.imageExporter.export(t,e)}catch(t){throw t}}}class g{static async processVerticalBox(t){const e=t.cloneNode(!0),n=document.createElement("div");n.style.position="fixed",n.style.left="-9999px",n.style.top="-9999px",n.style.opacity="0",document.body.appendChild(n),n.appendChild(e);const o=t.getBoundingClientRect();e.style.writingMode="horizontal-tb",e.style.transform="none",e.style.width=o.height+"px",e.style.height=o.width+"px",await new Promise((t=>requestAnimationFrame(t)));const a=(await html2canvas(e,{scale:2,backgroundColor:null})).toDataURL("image/png",1);return n.remove(),{dataUrl:a,cloneWidth:o.height,cloneHeight:o.width}}async export(t,e){try{const n=document.querySelectorAll(".ocr-container");if(0===n.length)return;const o=document.getElementById("pdf-viewer");let a=1;if(o&&o.style.transform){const t=o.style.transform.match(/scale\(([\d.]+)\)/);t&&t[1]&&(a=parseFloat(t[1]))}const r=n[0].querySelector("canvas[data-ocr-processed='true']");if(!r)throw new Error("No translations found");o.style.transform="scale(1)";const i=document.getElementById("zoomIn"),s=document.getElementById("zoomOut");i&&(i.disabled=!0),s&&(s.disabled=!0),await d.sleep(500);const l=r.offsetWidth,c=r.offsetHeight,p=l>c?"landscape":"portrait",{jsPDF:u}=window.jspdf,m=new u({orientation:p,unit:"px",format:[l,c]});e("⏳ Processing your PDF ⏳","success");let h=[];if("all"===t.type)h=Array.from({length:n.length},((t,e)=>e));else if("specific"===t.type)h=t.pages.map((t=>t-1)).filter((t=>t>=0&&t<n.length));else if("range"===t.type){const e=t.range.start-1,o=t.range.end-1;h=[];for(let t=e;t<=o&&t<n.length;t++)h.push(t)}for(let o=0;o<h.length;o++){const a=h[o],r=n[a];let i=r.querySelector("canvas[data-ocr-processed='true']");i&&S.updateOverlay(i),i||(i=r.querySelector("canvas"));const s=i?.offsetWidth||l,d=i?.offsetHeight||c,p=l>c?"landscape":"portrait",u=[],f=[];r.querySelectorAll(".ocr-box").forEach(((t,e)=>{const n=getComputedStyle(t);u[e]={background:n.background,backgroundColor:n.backgroundColor,boxShadow:n.boxShadow,overflow:n.overflow,height:n.height,maxHeight:n.maxHeight,padding:n.padding},t.style.boxShadow="none !important",t.style.overflow="visible",t.style.border="none !important",t.style.fontFamily=n.fontFamily,t.style.fontSize=n.fontSize,t.style.color=n.color,t.style.padding=n.padding,t.style.margin=n.margin,t.style.writingMode=n.writingMode,t.offsetWidth,("vertical-rl"===n.writingMode||n.transform&&("matrix(0, 1, -1, 0, 0, 0)"===n.transform||"matrix(0, -1, 1, 0, 0, 0)"===n.transform||n.transform.includes("rotate(90")||n.transform.includes("rotate(-90")||n.transform.includes("rotate(270")))&&f.push(t);const o=t.querySelectorAll("[class^='resize-handle']");for(const t of o)t.style.display="none"}));const x=[];for(const t of f){const{dataUrl:e,cloneWidth:n,cloneHeight:o}=await g.processVerticalBox(t),a=getComputedStyle(t),i=parseFloat(a.left)+o,s=parseFloat(a.top),l=new Image;l.src=e,l.style.position="absolute",l.style.width=n+"px",l.style.height=o+"px",l.setAttribute("width",2*n),l.setAttribute("height",2*o),l.style.left=i+"px",l.style.top=s+"px","vertical-rl"===t.style.writingMode?(l.style.transform="rotate(90deg)",l.style.transformOrigin="top left"):(l.style.left=i-o+"px",l.style.transform=t.style.transform,l.style.transformOrigin="bottom left"),l.style.zIndex="1000",r.appendChild(l),x.push({box:t,img:l}),t.style.display="none"}e(`Preparing translated page ${a+1}`,"warning");let y=r.querySelector("canvas[data-ocr-processed='true']");y||(y=r.querySelector("canvas"));const b=new Image;b.src=y.toDataURL("image/png"),b.style.width=s+"px",b.style.height=d+"px",b.setAttribute("width",s),b.setAttribute("height",d),b.style.position="absolute",b.style.top="0",b.style.left="0",b.style.zIndex="999",b.style.display="block",r.insertBefore(b,r.firstChild);const w=(await html2canvas(r,{width:s,height:d,windowWidth:s,windowHeight:d})).toDataURL("image/jpeg",t.quality);b.remove(),r.querySelectorAll(".ocr-box").forEach(((t,e)=>{const n=u[e];if(!n)return;t.style.background=n.background,t.style.backgroundColor=n.backgroundColor,t.style.boxShadow=n.boxShadow,t.style.overflow=n.overflow,t.style.height=n.height,t.style.maxHeight=n.maxHeight,t.style.padding=n.padding;const o=t.querySelectorAll("[class^='resize-handle']");for(const t of o)t.style.display=""}));for(const{box:t,img:e}of x)t.style.display="",e.remove();o>0&&(m.addPage([s,d],p),m.internal.pageSize.width=s,m.internal.pageSize.height=d,m.internal.pageSize.orientation=p),m.addImage(w,"JPEG",0,0,s,d),await new Promise((t=>setTimeout(t,500)))}o.style.transform="scale("+a+")",i&&(i.disabled=!1),s&&(s.disabled=!1),e("PDF Ready ✅","success");const f=fileName||"PDF";m.save(`${f}_translated.pdf`)}catch(t){throw t}}}class f{static async processPage(t,e){const n=await t.getPage(e);const o=n.getViewport({scale:2,dontFlip:!1}),a=document.createElement("canvas");a.width=o.width,a.height=o.height,a.style.width=o.width+"px",a.style.height=o.height+"px",a.crossOrigin="anonymous",a.style.zIndex="1";const r=a.getContext("2d"),i=document.createElement("div");i.classList.add("ocr-container"),i.style.position="relative",i.style.display="inline-block",await n.render({canvasContext:r,viewport:o}).promise;const s=await n.getTextContent();s.items.length>0&&(a.pdfTextContent={text:s,viewport:o}),i.appendChild(a);return document.getElementById("pdf-container").appendChild(i),d.observeCanvasResize(a),i}}class x{static restoreImageOverlay(){try{const t=document.getElementById("imageContainer"),e=document.getElementById("overlayCanvasImage");e&&e.remove(),t.querySelectorAll(".ocr-box").forEach((t=>{t.style.display=""}));const n=document.getElementById("downloadPdf");n&&(n.disabled=!1)}catch(t){}}static async processVerticalBox(t){const e=t.cloneNode(!0),n=document.createElement("div");n.style.position="fixed",n.style.left="-9999px",n.style.top="-9999px",n.style.opacity="0",document.body.appendChild(n),n.appendChild(e);const o=t.getBoundingClientRect();e.style.writingMode="horizontal-tb",e.style.transform="none",e.style.width=o.height+"px",e.style.height=o.width+"px",await new Promise((t=>requestAnimationFrame(t)));const a=(await html2canvas(e,{scale:2,backgroundColor:null})).toDataURL("image/png",1);return n.remove(),{dataUrl:a,cloneWidth:o.height,cloneHeight:o.width}}async export(e,n){try{const o=document.querySelectorAll(".ocr-container")[1],a=o.style.overflow,r=o.style.height,i=o.style.background;o.style.overflow="visible",o.style.height="auto";const s=document.getElementById("base64Image");if(!s)return void n("No image found","error");const l=s.getBoundingClientRect();let c=l.width,d=l.height;o.style.width=c+"px",o.style.height=d+"px",n("Preparing image ...","warning");const p=[];o.querySelectorAll(".ocr-box").forEach((t=>{const e=getComputedStyle(t);t.style.background=e.background,t.style.backgroundColor=e.backgroundColor,t.style.border=e.border,t.style.fontFamily=e.fontFamily,t.style.fontSize=e.fontSize,t.style.color=e.color,t.style.padding=e.padding,t.style.margin=e.margin,t.style.boxShadow=e.boxShadow,"vertical-rl"===e.writingMode&&p.push(t)}));const u=[];for(const t of p){const{dataUrl:e,cloneWidth:n,cloneHeight:a}=await x.processVerticalBox(t),r=getComputedStyle(t),i=parseFloat(r.left)+a,s=parseFloat(r.top),l=new Image;l.src=e,l.style.position="absolute",l.style.width=n+"px",l.style.height=a+"px",l.style.left=i+"px",l.style.top=s+"px",l.style.transform="rotate(90deg)",l.style.transformOrigin="top left",l.style.zIndex="1000",o.appendChild(l),u.push({box:t,img:l}),t.style.display="none"}const m=s.src,h=window.visualViewport?window.visualViewport.scale:1,g=new Image;1!==h&&(g.src=m,g.style.width=c+"px",g.style.height=d+"px",g.style.width="100%",g.style.height="100%",g.setAttribute("width",c),g.setAttribute("height",d),g.style.position="absolute",g.style.top="0",g.style.left="0",g.style.zIndex="999",g.style.display="block",o.insertBefore(g,o.firstChild));const f=(await html2canvas(o,{useCORS:!0,allowTaint:!1,...1!==h&&{width:c,height:d,windowWidth:c,windowHeight:d}})).toDataURL("image/png",e.quality);1!==h&&g?.remove();for(const{box:t,img:e}of u)t.style.display="",e.remove();if(o.style.overflow=a,o.style.height=r,o.style.background=i,t){n("Image Ready ✅","success");const t=document.createElement("a");t.href=f,t.download=`${fileName}_translated.png`,t.addEventListener("error",(()=>{n("Download canceled","warning")})),document.body.appendChild(t),t.click(),document.body.removeChild(t)}else{let t=document.getElementById("overlayCanvasImage");t||(t=document.createElement("img"),t.id="overlayCanvasImage",t.style.position="absolute",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="auto",t.style.zIndex="9998",o.appendChild(t)),t.src=f,t.style.display="block",o.querySelectorAll(".ocr-box").forEach((t=>{t.style.display="none"}));const e=document.getElementById("downloadPdf");e&&(e.disabled=!0);const a=document.querySelector(".headerButtons");if(a){const t=document.getElementById("editTranslationButton");t&&t.remove();const e=document.createElement("button");e.id="editTranslationButton",e.className="modernButton",e.textContent="Edit translation",e.onclick=function(){x.restoreImageOverlay(),e.remove()},a.appendChild(e)}n("Image Ready ✅","success",4e3),n("Hold the image to download it!","info",1e4)}}catch(t){}}}class y{constructor(t,e,n=1e3,o){this.translator=t,this.worker=o,this.pendingWorkerRequests={},this.queueDelay=n,this.type=e}initWorker(){this.worker.postMessage({action:"init",config:{apiKey:this.translator.apiKey,openAiUrl:this.translator.openAiUrl,model:this.translator.model,temperature:this.translator.temperature,targetLang:this.translator.targetLang,prompt:this.translator.prompt,type:this.type,callDelay:this.queueDelay}}),this.worker.addEventListener("message",(t=>{t.data.type;const e=t.data;e.requestId&&this.pendingWorkerRequests[e.requestId]&&("success"===e.status?this.pendingWorkerRequests[e.requestId].resolve(e.translation):this.pendingWorkerRequests[e.requestId].reject(new Error(e.error)),delete this.pendingWorkerRequests[e.requestId])}))}stopWorker(){this.worker.terminate(),this.worker=null,this.pendingWorkerRequests={}}async translateText(t){return new Promise(((e,n)=>{const o="req_"+c();this.pendingWorkerRequests[o]={resolve:e,reject:n},this.worker.postMessage({action:"translateText",text:t,requestId:o})}))}}class b{constructor(){return this.container=null,b.instance||(this.container=this._createContainer(),this.maxNotifications=3,b.instance=this),b.instance}setMaxNotifications(t){this.maxNotifications=t}_createContainer(){let t=document.getElementById("notificationContainer");return t||(t=document.createElement("div"),t.id="notificationContainer",document.body.appendChild(t)),t}showNotification(t,e="error",n=2e3){const o=document.createElement("div");for(this.container||(this.container=this._createContainer());this.container.children.length>=this.maxNotifications;)this.container.removeChild(this.container.firstChild);o.className=`notification ${e}`,o.textContent=t,this.container.appendChild(o),setTimeout((()=>{o.classList.add("fade-out"),o.addEventListener("animationend",(()=>o.remove()))}),n)}}class w{constructor(){this.notificationManager=new b,this.created=!1,this.removed=!1}initUI(){if(this.created)return;const t=this.createTranslationContainer();t&&!document.getElementById("resetButton")&&t.appendChild(this._createResetButton()),document.getElementById("translationFeedbackBox")||t.appendChild(this.createFeedbackBox()),setTimeout((()=>{t&&t.classList.add("hidden")}),1e3),this.created=!0}removeUI(t=2e3){if(this.removed)return;document.getElementById("translationContainer").classList.remove("hidden");const e=document.getElementById("translationFeedbackBox");setTimeout((()=>{e.classList.add("fade-out"),e.addEventListener("animationend",(()=>{e.remove(),document.getElementById("translationContainer").classList.remove("hidden")}))}),t),this.removed=!0}_createResetButton(){const t=document.createElement("button");return t.className="immTransl-control-btn reset",t.title="Reset",t.id="resetButton",t.innerHTML='<svg version="1.0" xmlns="http://www.w3.org/2000/svg"      width="24.000000pt" height="24.000000pt" viewBox="0 0 512.000000 512.000000"      preserveAspectRatio="xMidYMid meet">     <g transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)"     fill="#fff" stroke="none">     <path d="M2390 4794 c-441 -40 -832 -189 -1180 -448 -123 -91 -346 -315 -436     -436 -229 -308 -373 -652 -431 -1030 -24 -158 -24 -482 0 -640 50 -325 167     -635 341 -900 98 -149 164 -230 300 -366 344 -343 765 -554 1256 -630 159 -25     481 -25 640 0 825 127 1497 673 1784 1450 55 148 49 224 -23 289 -46 41 -68     49 -229 82 -128 26 -162 25 -222 -6 -60 -30 -97 -79 -139 -183 -145 -354 -401     -644 -726 -822 -726 -395 -1636 -169 -2097 520 -367 549 -355 1274 30 1816 86     121 251 286 372 372 169 120 400 223 592 262 439 90 826 4 1190 -266 l80 -60     -181 -182 c-116 -118 -187 -197 -197 -222 -53 -124 21 -267 151 -294 34 -7     256 -10 661 -8 l609 3 45 25 c24 14 58 45 75 68 l30 44 3 646 2 646 -26 53     c-33 69 -103 113 -180 113 -87 0 -130 -30 -343 -244 l-194 -194 -76 60 c-308     246 -651 403 -1011 463 -92 16 -379 27 -470 19z"/>     </g>     </svg>',t.disabled=!1,t.addEventListener("click",(t=>{d.resetTranslation(w.showNotification,this.updateFeedback),t.remove})),t}_createControlButtons(){const e=document.createElement("div");e.id="translationControls";const a=document.createElement("button");a.className="immTransl-control-btn pause",a.title="Pause",a.innerHTML='<svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="12.000000pt" height="12.000000pt" viewBox="0 0 512.000000 512.000000" preserveAspectRatio="xMidYMid meet">    <g transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)" fill="#fff" stroke="none">    <path d="M774 5104 c-16 -8 -39 -29 -50 -47 -19 -31 -19 -71 -19 -2497 0 -2429 0 -2465 20 -2497 38 -64 23 -63 660 -63 631 0 622 -1 662 58 17 26 18 131 18 2502 0 2371 -1 2476 -18 2502 -40 59 -31 58 -664 58 -494 0 -582 -3 -609 -16z"/>    <path d="M3123 5104 c-18 -9 -40 -28 -50 -43 -17 -25 -18 -135 -18 -2501 0 -2371 1 -2476 18 -2502 40 -59 31 -58 662 -58 637 0 622 -1 660 63 20 32 20     68 20 2497 0 2429 0 2465 -20 2497 -38 64 -23 63 -662 63 -506 0 -582 -2 -610 -16z"/></g></svg>    ',a.disabled=!1;const r=document.createElement("button");r.className="immTransl-control-btn resume",r.title="Resume",r.innerHTML='<svg version="1.0" xmlns="http://www.w3.org/2000/svg"       // width="12pt" height="12pt" viewBox="0 0 512.000000 512.000000"     preserveAspectRatio="xMidYMid meet">    <g transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)"    fill="#fff" stroke="none">    <path d="M620 5110 c-71 -15 -151 -60 -206 -115 -86 -85 -137 -210 -154 -375    -13 -129 -13 -3991 0 -4120 17 -165 68 -290 154 -375 149 -149 373 -163 619    -39 76 37 3457 1975 3546 2031 31 20 90 70 131 112 159 161 196 340 107 521    -37 76 -152 198 -238 253 -89 56 -3470 1994 -3546 2031 -37 19 -97 44 -133 56    -74 24 -214 34 -280 20z"/>    </g>    </svg>',r.disabled=!0;const i=document.createElement("button");return i.className="immTransl-control-btn cancel",i.title="Cancel",i.innerHTML='<svg version="1.0" xmlns="http://www.w3.org/2000/svg"      width="12.000000pt" height="12.000000pt" viewBox="0 0 512.000000 512.000000"      preserveAspectRatio="xMidYMid meet">     <g transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)"     fill="#fff" stroke="none">     <path d="M579 5107 c-26 -7 -68 -27 -95 -45 -58 -37 -401 -381 -431 -432 -36     -60 -56 -147 -49 -212 14 -133 -28 -86 888 -1003 461 -462 838 -847 838 -855     0 -8 -377 -393 -838 -855 -911 -912 -873 -869 -888 -997 -8 -72 17 -169 61     -233 19 -28 117 -132 217 -231 223 -221 254 -239 393 -239 164 1 96 -57 1044     891 458 459 838 833 843 832 6 -2 385 -378 842 -835 944 -944 878 -887 1041     -888 139 0 170 18 393 239 100 99 198 203 217 231 44 64 69 161 61 233 -15     128 23 85 -888 997 -461 462 -838 847 -838 855 0 8 377 393 838 855 911 912     873 869 888 997 8 72 -17 169 -61 233 -19 28 -117 132 -217 231 -223 221 -254     239 -393 239 -163 -1 -97 56 -1042 -889 -457 -457 -837 -831 -843 -831 -7 0     -386 374 -844 831 -741 741 -837 835 -890 859 -70 32 -177 42 -247 22z"/>     </g>     </svg>',i.disabled=!1,a.addEventListener("click",(()=>{n||(n=!0,this.updateFeedback("Translation Paused",!1),a.disabled=!0,r.disabled=!1)})),r.addEventListener("click",(()=>{n&&(n=!1,this.updateFeedback("Translation Resumed",!0),r.disabled=!0,a.disabled=!1)})),i.addEventListener("click",(()=>{o||(o=!0,this.updateFeedback("Translation Canceled",!1),a.disabled=!0,r.disabled=!0,i.disabled=!0,this.removeFeedback(0),t&&(document.getElementById("downloadPdf").disabled=!1),document.querySelectorAll(".text-spinner, .text-retry-button").forEach((t=>t.remove())))})),e.appendChild(a),e.appendChild(r),e.appendChild(i),e}createTranslationContainer(){if(!document.getElementById("translationContainer")){const t=document.createElement("div");return t.id="translationContainer",t.style.position="fixed",t.style.bottom="20px",t.style.right="20px",t.style.display="flex",t.style.alignItems="center",t.style.gap="8px",document.body.appendChild(t),t}}createFeedbackBox(){let t=document.getElementById("translationFeedbackBox");if(!t){t=document.createElement("div"),t.id="translationFeedbackBox";const e=document.createElement("div");e.className="immTransl-arrow",e.innerHTML='<svg version="1.0" xmlns="http://www.w3.org/2000/svg"\n             width="32.000000pt" height="32.000000pt" viewBox="0 0 512.000000 512.000000"\n             preserveAspectRatio="xMidYMid meet">\n            <g transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)"\n            fill="#fff" stroke="none">\n            <path d="M1400 5098 c-44 -17 -77 -44 -171 -137 -144 -143 -163 -177 -164\n            -286 0 -58 5 -91 19 -120 13 -27 333 -355 995 -1018 l976 -977 -977 -978\n            c-760 -760 -982 -987 -997 -1022 -14 -30 -21 -67 -21 -110 0 -103 29 -153 168\n            -291 98 -97 127 -119 175 -137 73 -28 131 -28 204 -1 56 20 108 71 1230 1193\n            1297 1296 1223 1214 1223 1346 0 132 74 50 -1223 1346 -1123 1123 -1174 1173\n            -1230 1193 -72 26 -136 26 -207 -1z"/>\n            </g>\n            </svg>\n              ',e.addEventListener("click",(function(t){t.stopPropagation(),document.getElementById("translationContainer").classList.toggle("hidden")})),t.appendChild(e);const n=document.createElement("div");n.className="spinner",n.addEventListener("click",(function(e){e.stopPropagation(),t.classList.toggle("hidden")})),t.appendChild(n);const o=document.createElement("span");o.id="feedbackText",o.textContent="Starting translation...",t.appendChild(o),t.appendChild(this._createControlButtons()),document.body.appendChild(t)}return t}updateFeedback(t,e=!0){const n=document.getElementById("translationFeedbackBox");if(n){const o=document.getElementById("feedbackText");o&&(o.textContent=t);const a=n.querySelector(".spinner");a&&(a.style.display=e?"block":"none")}}removeFeedback(t=2e3){document.getElementById("translationContainer").classList.remove("hidden");const e=document.getElementById("translationFeedbackBox");setTimeout((()=>{e.classList.add("fade-out"),e.addEventListener("animationend",(()=>{e.remove(),document.getElementById("translationContainer").classList.remove("hidden")}))}),t)}static showNotification(t,e,n){(new b).showNotification(t,e,n)}}class v extends w{constructor(){super(),this.currentPageIndex=0,this.totalPages=0,this.pageContainers=[],this.zoomFactor=1,this.zoomStep=.1,this.minZoom=.1,this.maxZoom=2,this.panzoom=null}static showNotification(t,e,n){super.showNotification(t,e,n)}initUI(){this.buildPdfViewer(),super.initUI()}removeUI(e){t&&v.enableDownloadButton(),super.removeUI(e)}async exportPdfCallback(){const t=document.querySelectorAll(".ocr-container");if(0===t.length)return;const e=t.length,n=await v.showPdfOptionsModal(e),o=new g,a=new u(o);try{await a.execute(n,v.showNotification)}catch(t){v.showNotification(t,"error")}}buildPdfViewer(){let t=document.getElementById("pdf-viewer");t||(t=document.createElement("div"),t.id="pdf-viewer",document.body.appendChild(t));let e=document.getElementById("pdf-toolbar");e||(e=document.createElement("div"),e.id="pdf-toolbar",e.innerHTML='\n            <button id="prevPage"><i class="fas fa-arrow-left"></i></button>\n            <span id="pageIndicator">0 of 0</span>\n            <button id="nextPage"><i class="fas fa-arrow-right"></i></button>\n   \n            <button id="zoomOut"><i class="fas fa-search-minus"></i></button>\n            <span id="zoomIndicator">100%</span>\n            <button id="zoomIn"><i class="fas fa-search-plus"></i></button>\n\n            <button id="downloadPdf" disabled><i class="fas fa-download"></i></button>\n          ',document.body.appendChild(e));let n=document.getElementById("pdf-container");n||(n=document.createElement("div"),n.id="pdf-container",t.appendChild(n));document.getElementById("downloadPdf").addEventListener("click",this.exportPdfCallback)}static async showPdfOptionsModal(t){return new Promise(((e,n)=>{if(document.getElementById("pdfOptionsOverlay"))return;const o=document.createElement("div");o.id="pdfOptionsOverlay";const a=document.createElement("div");a.id="pdfOptionsModal",a.innerHTML='\n          <h2>PDF Options</h2>\n          <form id="pdfOptionsForm">\n            <div>\n              <input type="radio" id="optionAll" name="pdfOption" value="all" checked>\n              <label for="optionAll">Entire PDF</label>\n            </div>\n            <div>\n              <input type="radio" id="optionSpecific" name="pdfOption" value="specific">\n              <label for="optionSpecific">Specific Pages</label>\n              <input type="text" id="specificPages" placeholder="e.g. 1,3,5" disabled>\n            </div>\n            <div>\n              <input type="radio" id="optionRange" name="pdfOption" value="range">\n              <label for="optionRange">Page Range</label>\n              <div style="display: flex; gap: 10px; margin-top: 8px;">\n                <input type="number" id="rangeStart" placeholder="From" disabled>\n                <input type="number" id="rangeEnd" placeholder="To" disabled>\n              </div>\n            </div>\n            <div class="quality-container">\n              <label for="pdfQuality">PDF Quality (Optimal 70%):</label>\n              <input type="range" id="pdfQuality" min="10" max="100" value="70" style="vertical-align: middle; margin: 0 8px;">\n              <span id="pdfQualityValue">70%</span>\n            </div>\n            <div class="button-group">\n              <button type="button" id="cancelPdfOptions">Cancel</button>\n              <button type="submit" id="confirmPdfOptions">Download</button>\n            </div>\n          </form>\n          ',o.appendChild(a),document.body.appendChild(o);const r=a.querySelector("#pdfQuality"),i=a.querySelector("#pdfQualityValue");r.addEventListener("input",(()=>{i.textContent=r.value+"%"}));const l=a.querySelector("#specificPages"),c=a.querySelector("#rangeStart"),d=a.querySelector("#rangeEnd");c.setAttribute("min","1"),c.setAttribute("max",t),d.setAttribute("min","1"),d.setAttribute("max",t);a.querySelectorAll('input[name="pdfOption"]').forEach((t=>{t.addEventListener("change",(()=>{l.disabled=!a.querySelector("#optionSpecific").checked,c.disabled=!a.querySelector("#optionRange").checked,d.disabled=!a.querySelector("#optionRange").checked}))}));a.querySelector("#pdfOptionsForm").addEventListener("submit",(n=>{n.preventDefault();const r=a.querySelector('input[name="pdfOption"]:checked').value,i={type:r,quality:a.querySelector("#pdfQuality").value/100};if("range"===r){const e=parseInt(c.value),n=parseInt(d.value);if(isNaN(e)||isNaN(n))return void alert("Please enter valid numbers for the range.");if(e<1||n<1||e>t||n>t)return void alert(`The range must be between 1 and ${t}.`);if(e>n){return void alert("The starting page cannot be greater than the ending page.");s}i.range={start:e,end:n}}else if("specific"===r){let e=l.value.split(",").map((t=>parseInt(t.trim()))).filter((t=>!isNaN(t)));if(0===e.length)return void alert("Please enter at least one valid page number.");if(e.filter((e=>e<1||e>t)).length>0)return void alert(`All page numbers must be between 1 and ${t}.`);i.pages=e}document.body.removeChild(o),e(i)}));a.querySelector("#cancelPdfOptions").addEventListener("click",(()=>{document.body.removeChild(o)}))}))}applyZoom(){const t=document.getElementById("pdf-viewer");if(!t)return;const e=t.getBoundingClientRect(),n=Math.max(e.left,0),o=Math.max(e.top,0),a=(n+Math.min(e.right,window.innerWidth))/2,r=(o+Math.min(e.bottom,window.innerHeight))/2,i=window.scrollX+a,s=window.scrollY+r,l=e.left+window.scrollX,c=e.top+window.scrollY,d=i-l,p=s-c,u=this.zoomFactorOld||1,m=this.zoomFactor,h=d/u,g=p/u;if(t.style.transition="transform 0.05s ease",m<1){this.currentPageIndex;t.style.transformOrigin="top center",t.style.transform=`scale(${m})`;const e=c+g*m,n=(window.innerWidth,e-window.innerHeight/2);window.scrollTo({top:n})}else{t.style.transformOrigin="top left",t.style.transform=`scale(${m})`;const e=c+g*m,n=l+h*m-window.innerWidth/2,o=e-window.innerHeight/2;window.scrollTo({left:n,top:o})}this.zoomFactorOld=m}updateOcrBoxesForZoom(t){if(0===t.querySelectorAll(".ocr-box").length)return;const e=t.querySelector("canvas");e&&S.updateOverlay(e,null,null)}zoomIn(){this.zoomFactor<this.maxZoom&&(this.zoomFactor=Math.min(this.maxZoom,this.zoomFactor+this.zoomStep),this.applyZoom(),this.updateZoomIndicator())}zoomOut(){if(this.zoomFactor>this.minZoom){this.zoomFactor;this.zoomFactor=Math.max(this.minZoom,this.zoomFactor-this.zoomStep),this.applyZoom(),this.updateZoomIndicator()}}updateZoomIndicator(){const t=document.getElementById("zoomIndicator"),e=Math.round(100*this.zoomFactor);t.textContent=`${e}%`}updatePageIndicator(){document.getElementById("pageIndicator").textContent=`${this.currentPageIndex+1} of ${this.totalPages}`}showCurrentPage(){if(this.pageContainers.forEach(((t,e)=>{t.style.display="block"})),this.pageContainers[this.currentPageIndex]){this.pageContainers[this.currentPageIndex].scrollIntoView({behavior:"smooth",block:"start"});this.pageContainers[this.currentPageIndex].querySelector("canvas")}}addToolbarListeners(t,e,n,o){document.getElementById("pdf-container");document.getElementById("prevPage").addEventListener("click",(async()=>{this.currentPageIndex>0&&(this.currentPageIndex--,this.showCurrentPage())})),document.getElementById("nextPage").addEventListener("click",(()=>{this.currentPageIndex<this.totalPages-1&&(this.currentPageIndex++,this.showCurrentPage())})),document.getElementById("zoomIn").addEventListener("click",(()=>{this.zoomIn()})),document.getElementById("zoomOut").addEventListener("click",(()=>{this.zoomOut()}))}async createPdfPages(t){this.totalPages=t.numPages;const e=new f,n=new m(e),o=new IntersectionObserver((t=>{t.forEach((t=>{const e=(()=>{const t=window.innerWidth;return t<=600?.5:t<=1200?.35:t<=1800?.25:.15})();t.isIntersecting&&t.intersectionRatio*this.zoomFactor>=e&&(this.currentPageIndex=Array.from(this.pageContainers).indexOf(t.target),this.updatePageIndicator())}))}),{root:null,threshold:[0,.15,.25,.35,.5,.75,1],rootMargin:"0px"});this.pageContainers=[];for(let e=1;e<=this.totalPages;e++){const a=await n.execute(t,e);this.pageContainers.push(a),o.observe(a)}return this.currentPageIndex=0,this.showCurrentPage(),this.addToolbarListeners(),this.updateZoomIndicator(),this.pageContainers}static enableDownloadButton(){document.getElementById("downloadPdf").disabled=!1}static disableDownloadButton(){document.getElementById("downloadPdf").disabled=!0}}class E extends w{constructor(){super()}initUI(){this.created||(super.initUI(),this._loadBase64Image(),document.getElementById("downloadPdf").addEventListener("click",this.exportImageCallback.bind(this)))}removeUI(t){this.removed||(super.removeUI(t),E.enableDownloadButton())}static enableDownloadButton(){document.getElementById("downloadPdf").disabled=!1}static disableDownloadButton(){document.getElementById("downloadPdf").disabled=!0}exportImageCallback(){const t={quality:1},e=new x,n=new h(e);try{n.execute(t,w.showNotification)}catch(t){w.showNotification(t,"error")}}_loadBase64Image(){try{const t=document.getElementById("base64Image"),e=`data:image/${fileType};base64,${base64Data.data}`;t.src=e,t.alt=fileName,d.observeCanvasResize(t)}catch(t){}}}class k{static createUIManager(t){switch(t){case"pdf":return new v;case"image":return new E;case"page":return new w;default:return new w}}}class C{async recognize(t,e){throw new Error("Metodo recognize() non implementato in OCREngine")}async initEngine(){throw new Error("Metodo initEngine() non implementato in OCREngine")}async terminateEngine(){throw new Error("Metodo terminateEngine() non implementato in OCREngine")}}class I extends C{constructor(t="eng",e=null){super(),this.worker=null,this.languages=t,this.tesseractOptions=e}async initEngine(){this.worker=await Tesseract.createWorker(this.languages),this.tesseractOptions&&await this.worker.setParameters(this.tesseractOptions)}async terminateEngine(){this.worker&&await this.worker.terminate()}async recognize(t,e){const n={...e,lang:this.languages};return await(this.worker?.recognize(t,n,{blocks:!0}))}}class S{constructor(t,e){this.adapter=t,this.translator=e,this._overlayUpdateScheduled=!1}static debouncedUpdate(t,e,n){S.debounce(((t,e,n)=>{S.updateOverlay(t,e,n),this._overlayUpdateScheduled=!1}),100)(t,e,n)}async process(t){throw new Error("Metodo process() non implementato in OCRStrategy")}static adjustFontSize(t){const e=t.querySelectorAll(".resize-handle"),n=[];e.forEach((t=>{n.push(t.style.display),t.style.display="none"}));let o,a=1e-5,r=30;for(let e=0;e<10;e++)o=(a+r)/2,t.style.fontSize=o+"px",t.scrollHeight<=t.clientHeight?a=o:r=o;t.style.fontSize=a+"px";let i=0;e.forEach((t=>{t.style.display=n[i++]}))}static retryOcrBoxTranslation(t,e,n){const o=Array.from(t.parentElement.querySelectorAll(".ocr-box")),a=o.find((t=>parseInt(t.getAttribute("data-ocr-index"),10)===Number(e)));if(e<0||e>=o.length)return;if(!a)return;const r=a.getAttribute("data-ocr-info");if(!r)return;const i=JSON.parse(r),s=n||t.ocrTranslator;s&&(i.translatedText="",a.setAttribute("data-ocr-info",JSON.stringify(i)),S.updateBoxesInChunks(t,[a]),s.translateText(i.originalText.replace(/<br>/gi,"[[BR]]")).then((e=>{const n=d.decodeHTMLEntities(e).replace(/\[\[BR\]\]/g,"<br>");i.translatedText=n,a.setAttribute("data-ocr-info",JSON.stringify(i)),S.updateBoxesInChunks(t,[a])})).catch((e=>{i.translatedText="[[ERROR]]",a.setAttribute("data-ocr-info",JSON.stringify(i)),S.updateBoxesInChunks(t,[a])})))}static sampleMedianColor(t,e,n,o,a){const r=t.getImageData(e,n,o,a).data,i=[],s=[],l=[],c=[];for(let t=0;t<r.length;t+=4)i.push(r[t]),s.push(r[t+1]),l.push(r[t+2]),c.push(r[t+3]);function d(t){t.sort(((t,e)=>t-e));const e=Math.floor(t.length/2);return t.length%2==0?(t[e-1]+t[e])/2:t[e]}return{r:d(i),g:d(s),b:d(l),a:d(c)}}static getCtxFromElement(t,e=null){return t?e?e.getContext("2d"):"function"==typeof t.getContext?t.getContext("2d"):null:null}static updateBoxesInChunks(t,e,n,o,a,r,i,s=null){const l=s||t.ocrTranslator;if(1===e.length){let t=e[0];const n=t.getAttribute("data-ocr-info");if(n){const e=JSON.parse(n);setTimeout((()=>d(t,e,0)),50)}return}if(null!=i&&i>=0&&i<e.length){let t=e[i];const n=t.getAttribute("data-ocr-info");if(n){const e=JSON.parse(n);setTimeout((()=>d(t,e,i)),50)}return}let c=0;function d(e,i,s){if(!e)return;const c=e.innerHTML.trim(),{bbox:d,translatedText:p,baseline:u}=i,m=n+d.x0*a,h=o+d.y0*a,g=(d.x1-d.x0)*a,f=(d.y1-d.y0)*a;if(Object.assign(e.style,{position:"absolute",left:`${m}px`,top:`${h}px`,width:`${g}px`,height:`${f}px`}),-1===s&&(c.includes('class="spinner"')||c.includes("ocr-retry-btn")))return;if(p&&""!==p)if("[[ERROR]]"===p){e.querySelectorAll(":scope > .spinner, :scope > .ocr-retry-btn, :scope > .ocr-box-text").forEach((t=>t.remove()));const n=document.createElement("button");n.className="ocr-retry-btn",n.textContent="↻",n.onclick=function(n){n.preventDefault(),n.stopPropagation(),S.retryOcrBoxTranslation(t,e.dataset.index,l)},e.appendChild(n),e.classList.add("ocr-box-error"),e.style.cursor="pointer",e.contentEditable="false"}else{e.querySelectorAll(":scope > .spinner, :scope > .ocr-retry-btn, :scope > .ocr-box-text").forEach((t=>t.remove()));const n=document.createElement("div");n.className="ocr-box-text",n.innerHTML=p,e.appendChild(n),e.classList.remove("ocr-box-error"),S.calculateBoxColor(i,t,r,d,e,parseInt(e.dataset.index)),S.adjustFontSize(e)}else{e.querySelectorAll(":scope > .spinner, :scope > .ocr-retry-btn, :scope > .ocr-box-text").forEach((t=>t.remove()));const t=document.createElement("div");t.className="spinner",e.appendChild(t),e.classList.remove("ocr-box-error"),e.style.cursor="default",e.contentEditable="false"}if(-1===s&&""!==c&&!c.includes('class="spinner"')&&!c.includes("ocr-retry-btn")){try{S.adjustFontSize(e)}catch(t){}return}let x=0,y=!1,b=0,w=0;if(u&&void 0!==u.x0&&void 0!==u.y0&&void 0!==u.x1&&void 0!==u.y1&&d){b=u.x1-u.x0,w=u.y1-u.y0;const t=Math.sqrt(b*b+w*w)*Math.cos(80*Math.PI/180);if(Math.abs(b)<t){const t=d.x1-d.x0;y=!0,d.y1-d.y0<1.5*t&&(x=Math.atan2(w,b)*(180/Math.PI),x>90?x-=180:x<-90&&(x+=180))}else x=Math.atan2(w,b)*(180/Math.PI),x>90?x-=180:x<-90&&(x+=180)}y?90!=x&&-90!=x?(e.style.writingMode="vertical-rl",e.style.transformOrigin="center center"):(e.style.transformOrigin="bottom left",e.style.transform=w<0?`rotate(${x}deg) scaleX(1)`:""):(e.style.transform=`rotate(${x}deg)`,e.style.transformOrigin="top left")}try{S.adjustFontSize(box)}catch(t){}requestAnimationFrame((function t(){for(let t=0;t<5&&c<e.length;t++,c++){let t=e[c];const n=t.getAttribute("data-ocr-info");if(!n)continue;d(t,JSON.parse(n),-1)}c<e.length&&setTimeout(t,50)}))}static updateOverlay(t,n=null,o=null,a=null){const r=t.parentElement;if(!t.ocrData){const i=Array.from(r.querySelectorAll(".ocr-box")).sort(((t,e)=>parseInt(t.getAttribute("data-ocr-index"),10)-parseInt(e.getAttribute("data-ocr-index"),10)));if(0===i.length)return;const s=t.getBoundingClientRect(),l=r.getBoundingClientRect(),c=t.ocrBaseWidth||s.width;let d=0;const p=document.getElementById("pdf-viewer");if(e&&p&&p.style.transform){const t=p.style.transform.match(/scale\(([\d.]+)\)/);t&&t[1]&&(d=parseFloat(t[1]))}let u=d>0?s.width/c/d:s.width/c;const m=s.left-l.left,h=s.top-l.top;let g=-1;return o>=0&&(g=o),S.enableDragResizeForBoxes(t,n),void S.updateBoxesInChunks(t,i,m,h,u,n,g,a)}const i=t.getBoundingClientRect(),s=r.getBoundingClientRect(),l=t.ocrBaseWidth||i.width;let c=0;const d=document.getElementById("pdf-viewer");if(e&&d&&d.style.transform){const t=d.style.transform.match(/scale\(([\d.]+)\)/);t&&t[1]&&(c=parseFloat(t[1]))}let p=c>0?i.width/l/c:i.width/l;const u=i.left-s.left,m=i.top-s.top;let h=r._ocrBoxes||[];if(h.length<t.ocrData.length){const e=document.createDocumentFragment();for(let n=h.length;n<t.ocrData.length;n++){const o=document.createElement("div");o.className="ocr-box",o.dataset.index=n,o.setAttribute("data-ocr-index",n),o._keydownHandler=function(e){if("Backspace"===e.key&&""===o.innerText.trim()){e.preventDefault();const n=parseInt(o.dataset.index,10);o.remove(),t.ocrData&&n>=0&&n<t.ocrData.length&&(t.ocrData[n]=null)}},o.addEventListener("keydown",o._keydownHandler),o._beforeinputHandler=function(e){if("deleteContentBackward"===e.inputType&&""===o.innerText.trim()){e.preventDefault();const n=parseInt(o.dataset.index,10);o.remove(),t.ocrData&&n>=0&&n<t.ocrData.length&&(t.ocrData[n]=null)}},o.addEventListener("beforeinput",o._beforeinputHandler),o.setAttribute("data-ocr-info",JSON.stringify(t.ocrData[n])),e.appendChild(o),h.push(o)}r.appendChild(e)}if(h.length>t.ocrData.length)for(let e=t.ocrData.length;e<h.length;e++)h[e].remove();let g=-1;o>=0&&(g=o),S.updateBoxesInChunks(t,h,u,m,p,n,g,a),S.enableDragResizeForBoxes(t,n),delete t.ocrData,delete r._ocrBoxes}static calculateBoxColor(t,e,n,o,a,r,i=!1){try{if(!t.color||i){const r=S.getCtxFromElement(e,n);if(r){const e=Math.floor(o.x0),n=Math.floor(o.y0),i=Math.max(1,Math.floor(o.x1-o.x0)),s=Math.max(1,Math.floor(o.y1-o.y0)),l=S.sampleMedianColor(r,e,n,i,s);a.style.background=`rgba(${l.r}, ${l.g}, ${l.b}, ${l.a/255})`;const c=(299*l.r+587*l.g+114*l.b)/1e3;a.style.color=c<128?"#fff":"#000",t.color=l,a.setAttribute("data-ocr-info",JSON.stringify(t))}}}catch(t){}}static _initializedBoxes=new WeakSet;static enableDragResizeForBoxes(t,n=null){const o=t.parentElement,a=o.querySelectorAll(".ocr-box"),r=t.ocrBaseWidth||t.naturalWidth||t.width,i=o.getBoundingClientRect(),s=t.getBoundingClientRect(),l=s.left-i.left,c=s.top-i.top;let d=0;const p=document.getElementById("pdf-viewer");if(e&&p&&p.style.transform){const t=p.style.transform.match(/scale\(([\d.]+)\)/);t&&t[1]&&(d=parseFloat(t[1]))}let u;u=d>0?s.width/r/d:s.width/r,a.forEach((e=>{if(S._initializedBoxes.has(e))return;const o={};["top","right","bottom","left"].forEach((t=>{const n=document.createElement("div");n.className="resize-handle "+t,n.style.position="absolute",n.style.background="transparent","top"===t||"bottom"===t?(n.style.height="8px",n.style.width="100%",n.style.left="0",n.style.cursor="ns-resize","top"===t?n.style.top="-4px":n.style.bottom="-4px"):(n.style.width="8px",n.style.height="100%",n.style.top="0",n.style.cursor="ew-resize","left"===t?n.style.left="-4px":n.style.right="-4px"),e.appendChild(n),o[t]=n}));["top-left","top-right","bottom-right","bottom-left"].forEach((t=>{const n=document.createElement("div");n.className="resize-handle "+t,n.style.position="absolute",n.style.background="transparent",n.style.width="12px",n.style.height="12px","top-left"===t?(n.style.top="-6px",n.style.left="-6px",n.style.cursor="nwse-resize"):"top-right"===t?(n.style.top="-6px",n.style.right="-6px",n.style.cursor="nesw-resize"):"bottom-right"===t?(n.style.bottom="-6px",n.style.right="-6px",n.style.cursor="nwse-resize"):"bottom-left"===t&&(n.style.bottom="-6px",n.style.left="-6px",n.style.cursor="nesw-resize"),e.appendChild(n),o[t]=n}));let a,r,i,s,d=null,p=!1,m=null,h=0,g=!1;function f(t){t.preventDefault()}function x(t){if(!(t.target.classList.contains("resize-handle")||e.contains(document.activeElement)&&document.activeElement.classList.contains("ocr-box-text"))){if(e.getElementsByClassName("ocr-box-text").length>0){const t=e.getElementsByClassName("ocr-box-text")[0];t&&(t.contentEditable="false")}h=Date.now(),d=this,m=setTimeout((()=>{p=!0,g=!0,e.style.cursor="move",e.classList.add("dragging"),function n(){const t=document.getElementById("pdf-container");t&&(t.classList.add("dragging"),t.addEventListener("touchmove",f,{passive:!1}))}(),document.addEventListener("mousemove",b),document.addEventListener("touchmove",b,{passive:!1}),a=t.touches?t.touches[0].clientX:t.clientX,r=t.touches?t.touches[0].clientY:t.clientY,i=parseFloat(getComputedStyle(e).left)||0,s=parseFloat(getComputedStyle(e).top)||0,t.preventDefault()}),300)}}function y(e){if(m){clearTimeout(m),m=null,d&&d.focus();const t=d?d.getElementsByClassName("ocr-box-text")[0]:null;t&&(t.contentEditable="true",t.focus())}if(p&&d){document.removeEventListener("mousemove",b),document.removeEventListener("touchmove",b);let o=d;o.style.cursor="default",o.classList.remove("dragging"),function a(){const t=document.getElementById("pdf-container");t&&(t.classList.remove("dragging"),t.removeEventListener("touchmove",f,{passive:!1}))}(),p=!1,g&&(S.updateBoxOcrData(o,l,c,u,t,n),g=!1);let r=o.getElementsByClassName("ocr-box-text")[0];r&&(r.contentEditable="true",r.blur()),o.blur(),e.preventDefault(),e.stopPropagation(),d=null}else{let t=d;if(t){if(t.focus(),t.getElementsByClassName("ocr-box-text").length>0){let e=t.getElementsByClassName("ocr-box-text")[0];e&&(e.contentEditable="true",e.focus())}t.style.cursor="text",d=null}}}function b(t){if(!p)return;const n=t.touches?t.touches[0].clientX:t.clientX,o=t.touches?t.touches[0].clientY:t.clientY,l=n-a,c=o-r;e.style.left=i+l+"px",e.style.top=s+c+"px",g=!0,t.preventDefault()}function w(o,a){let r,i,s,d,p,m,h=!1,g=!1;function f(t){h=!0,g=!1,r=t.touches?t.touches[0].clientX:t.clientX,i=t.touches?t.touches[0].clientY:t.clientY,s=parseFloat(getComputedStyle(e).width)||e.offsetWidth,d=parseFloat(getComputedStyle(e).height)||e.offsetHeight,p=parseFloat(getComputedStyle(e).left)||0,m=parseFloat(getComputedStyle(e).top)||0,document.addEventListener("mousemove",x),document.addEventListener("touchmove",x,{passive:!1}),document.addEventListener("mouseup",y),document.addEventListener("touchend",y),t.stopPropagation(),t.preventDefault()}function x(t){if(!h)return;const n=t.touches?t.touches[0].clientX:t.clientX,o=t.touches?t.touches[0].clientY:t.clientY;a(e,s,d,p,m,n-r,o-i),g=!0,t.preventDefault()}function y(o){h&&(h=!1,document.removeEventListener("mousemove",x),document.removeEventListener("touchmove",x),document.removeEventListener("mouseup",y),document.removeEventListener("touchend",y),g&&(S.updateBoxOcrData(e,l,c,u,t,n,!0),g=!1))}o._resizeHandlers&&(document.removeEventListener("mousemove",o._resizeHandlers.mousemove),document.removeEventListener("touchmove",o._resizeHandlers.touchmove),document.removeEventListener("mouseup",o._resizeHandlers.mouseup),document.removeEventListener("touchend",o._resizeHandlers.touchend)),o.addEventListener("mousedown",f),o.addEventListener("touchstart",f)}e.addEventListener("mousedown",x),e.addEventListener("touchstart",x,{passive:!1}),document.addEventListener("mouseup",y),document.addEventListener("touchend",y),e._dragHandlers={mousemove:b,touchmove:b},w(o.right,(function(t,e,n,o,a,r,i){t.style.width=e+r+"px",S.adjustFontSize(t)})),w(o.left,(function(t,e,n,o,a,r,i){t.style.width=e-r+"px",t.style.left=o+r+"px",S.adjustFontSize(t)})),w(o.bottom,(function(t,e,n,o,a,r,i){t.style.height=n+i+"px",S.adjustFontSize(t)})),w(o.top,(function(t,e,n,o,a,r,i){t.style.height=n-i+"px",t.style.top=a+i+"px",S.adjustFontSize(t)})),w(o["top-left"],(function(t,e,n,o,a,r,i){t.style.width=e-r+"px",t.style.height=n-i+"px",t.style.left=o+r+"px",t.style.top=a+i+"px",S.adjustFontSize(t)})),w(o["top-right"],(function(t,e,n,o,a,r,i){t.style.width=e+r+"px",t.style.height=n-i+"px",t.style.top=a+i+"px",S.adjustFontSize(t)})),w(o["bottom-right"],(function(t,e,n,o,a,r,i){t.style.width=e+r+"px",t.style.height=n+i+"px",S.adjustFontSize(t)})),w(o["bottom-left"],(function(t,e,n,o,a,r,i){t.style.width=e-r+"px",t.style.height=n+i+"px",t.style.left=o+r+"px",S.adjustFontSize(t)})),S._initializedBoxes.add(e)}))}static updateBoxOcrData(t,e,n,o,a,r=null,i=!1){const s=getComputedStyle(t),l=parseFloat(s.left),c=parseFloat(s.top),d=(l-e)/o,p=(c-n)/o,u=(l-e+parseFloat(s.width))/o,m=(c-n+parseFloat(s.height))/o,h=parseInt(t.dataset.index,10),g=t.getAttribute("data-ocr-info");if(g){let e=JSON.parse(g);e.bbox={x0:d,y0:p,x1:u,y1:m},t.setAttribute("data-ocr-info",JSON.stringify(e)),i&&S.calculateBoxColor(e,a,r,e.bbox,t,h,i)}}static groupOcrData(t,e=20,n=2){if(!t||!Array.isArray(t)||0===t.length)return[];function o(t){const{x0:e,y0:n,x1:o,y1:a}=t.bbox,r=(e+o)/2,i=(n+a)/2,s=o-e,l=a-n;let c=0;return t.baseline&&void 0!==t.baseline.x0&&void 0!==t.baseline.y0&&void 0!==t.baseline.x1&&void 0!==t.baseline.y1&&(c=Math.atan2(t.baseline.y1-t.baseline.y0,t.baseline.x1-t.baseline.x0)*(180/Math.PI)),{xCenter:r,yCenter:i,width:s,height:l,angle:c}}const a=t.map((t=>({item:t,features:o(t)})));let r=0,i=0;function s(t,e){const{x0:n,y0:o,x1:a,y1:r}=t;switch(e){case"right":return[{x:a,y:o},{x:a,y:(o+r)/2},{x:a,y:r}];case"left":return[{x:n,y:o},{x:n,y:(o+r)/2},{x:n,y:r}];case"top":return[{x:n,y:o},{x:(n+a)/2,y:o},{x:a,y:o}];case"bottom":return[{x:n,y:r},{x:(n+a)/2,y:r},{x:a,y:r}];default:return[{x:n,y:o},{x:a,y:o},{x:a,y:r},{x:n,y:r},{x:(n+a)/2,y:o},{x:a,y:(o+r)/2},{x:(n+a)/2,y:r},{x:n,y:(o+r)/2}]}}function l(t,e){const n=t.item.bbox,o=e.item.bbox,a=s(n),r=s(o);let i=1/0;for(let t=0;t<a.length;t++)for(let e=0;e<r.length;e++){const n=a[t].x-r[e].x,o=a[t].y-r[e].y,s=Math.sqrt(n*n+o*o);s<i&&(i=s)}const l=t.features.angle,c=e.features.angle;let d=Math.abs(l-c);return d>90&&(d=180-d),i+d}a.forEach((t=>{r+=t.features.width,i+=t.features.height}));const c=[],d=new Array(a.length).fill(!1),p=new Array(a.length).fill(!1),u=[];function m(t){const n=[];for(let o=0;o<a.length;o++)o!==t&&l(a[t],a[o])<=e&&n.push(o);return n}function h(t,e,o){o.push(t),p[t]=!0;let a=[...e];for(;a.length>0;){const t=a.shift();if(!d[t]){d[t]=!0;const e=m(t);e.length>=n&&(a=a.concat(e))}p[t]||(o.push(t),p[t]=!0)}}for(let t=0;t<a.length;t++){if(d[t])continue;d[t]=!0;const e=m(t);if(e.length<n)u.push(t);else{const n=[];h(t,e,n),c.push(n)}}function g(t){const e=t.slice().sort(((t,e)=>t-e)),n=Math.floor(e.length/2);return e.length%2==0?(e[n-1]+e[n])/2:e[n]}u.filter((t=>!p[t])).forEach((t=>{c.push([t])}));return c.map((t=>{const e=t.map((t=>a[t].item));e.sort(((t,e)=>t.bbox.y0!==e.bbox.y0?t.bbox.y0-e.bbox.y0:t.bbox.x0-e.bbox.x0));const n=Math.min(...e.map((t=>t.bbox.x0))),o=Math.min(...e.map((t=>t.bbox.y0))),r=Math.max(...e.map((t=>t.bbox.x1))),i=Math.max(...e.map((t=>t.bbox.y1))),s=e.map((t=>t.text)).join(" "),l=e.map((t=>t.baseline)).filter((t=>t));return{bbox:{x0:n,y0:o,x1:r,y1:i},baseline:{x0:g(l.map((t=>t.x0))),y0:g(l.map((t=>t.y0))),x1:g(l.map((t=>t.x1))),y1:g(l.map((t=>t.y1)))},originalText:s,translatedText:""}}))}static debounce(t,e){let n;return function(...o){clearTimeout(n),n=setTimeout((()=>t.apply(this,o)),e)}}scheduleOverlayUpdate(t,e=null,n=null){this._overlayUpdateScheduled||(this._overlayUpdateScheduled=!0,requestAnimationFrame((()=>{S.debouncedUpdate(t,e,n)})))}static getResultLines(t){if(!t||!t.data||!t.data.blocks)return t.data={lines:[]},t;const e=t.data.blocks.map((t=>t.paragraphs.map((t=>t.lines)))).flat(2);return t.data.lines=e,t}async _processOcrResult(t,e,n,o,a=20){o.data&&o.data.lines||(o=S.getResultLines(o));let r=o.data.lines.filter((t=>""!==t.text.trim()));if(0===r.length)return t.ocrData=[],void(t.dataset.ocrProcessed="true");const i=r.map((t=>({bbox:t.bbox,baseline:t.baseline,translatedText:"",text:t.text.trim()}))),s=S.groupOcrData(i,a);t.ocrData=s,"static"===getComputedStyle(e).position&&(e.style.position="relative"),d.checkPaused(),d.yieldControl(),S.updateOverlay(t,n);const l=Array.from(t.parentElement.querySelectorAll(".ocr-box")).sort(((t,e)=>parseInt(t.getAttribute("data-ocr-index"),10)-parseInt(e.getAttribute("data-ocr-index"),10))),c=s.map((t=>t.originalText.replace(/<br>/gi,"[[BR]]"))).map(((e,o)=>(async()=>{await d.checkPaused();const a=this.translator;try{const r=await a.translateText(e),i=l[o];if(!i)return;let s=JSON.parse(i.getAttribute("data-ocr-info"));s.translatedText=d.decodeHTMLEntities(r.trim()).replace(/\[\[BR\]\]/g,"<br>"),i.setAttribute("data-ocr-info",JSON.stringify(s)),S.updateOverlay(t,n,o,a)}catch(e){const r=l[o];if(!r)return;let i=JSON.parse(r.getAttribute("data-ocr-info"));i.translatedText="[[ERROR]]",r.setAttribute("data-ocr-info",JSON.stringify(i)),S.updateOverlay(t,n,o,a)}await d.yieldControl()})()));await Promise.all(c),t.dataset.ocrProcessed="true"}}class O extends S{constructor(t,e){super(t,e)}async process(t){if(await d.checkPaused(),"true"===t.dataset.ocrProcessed)return;t.complete||await new Promise((e=>{t.onload=e}));let e=t;if(!t.crossOrigin||"anonymous"!==t.crossOrigin)try{const n=await fetch(t.src),o=await n.blob(),a=await new Promise(((t,e)=>{const n=new FileReader;n.onload=()=>t(n.result),n.onerror=e,n.readAsDataURL(o)}));e=new Image,e.src=a,await new Promise((t=>{e.onload=t}))}catch(t){}let n=t.parentElement;n.classList.contains("ocr-container")||(n=document.createElement("div"),n.classList.add("ocr-container"),n.style.position="relative",n.style.display="flex",t.parentElement.insertBefore(n,t),n.appendChild(t));const o=e.naturalWidth,a=e.naturalHeight;t.ocrBaseWidth=o,t.ocrBaseHeight=a;const r=document.createElement("canvas");r.width=o,r.height=a;r.getContext("2d").drawImage(e,0,0,o,a),d.observeCanvasResize(t);const i=await this.adapter.recognize(r,{});if(!i)throw new Error("Can't process Image OCR");return await this._processOcrResult(t,n,r,i,40)}}class B extends S{constructor(t,e){super(t,e)}static mapPdfTextToOcrResult(t,e){if(!t||!t.items)throw new Error("Contenuto testo PDF non valido");return{data:{lines:t.items.filter((t=>t.str&&""!==t.str.trim())).map((t=>{const n=pdfjsLib.Util.transform(e.transform,t.transform),o=n[4],a=n[5],r=t.width*e.scale,i={x0:o,y0:a-t.height*e.scale,x1:o+r,y1:a},s={x0:n[4],y0:n[5],x1:n[4]+n[0]*t.width,y1:n[5]+n[1]*t.width};return{bbox:i,text:t.str.replace(/→/g,""),translatedText:"",baseline:s,has_baseline:!0}}))}}}async process(t){if(await d.checkPaused(),"true"===t.dataset.ocrProcessed)return;let e=t.parentElement;e.classList.contains("ocr-container")||(e=document.createElement("div"),e.classList.add("ocr-container"),e.style.position="relative",e.style.display="inline-block",t.parentElement.insertBefore(e,t),e.appendChild(t));const n=t.width,o=t.height;t.ocrBaseWidth=n,t.ocrBaseHeight=o;const a=document.createElement("canvas");a.width=n,a.height=o;let r;if(a.getContext("2d").drawImage(t,0,0,n,o),t.pdfTextContent){if(r=B.mapPdfTextToOcrResult(t.pdfTextContent.text,t.pdfTextContent.viewport),!r)throw new Error("PDF Text mapping error")}else if(r=await this.adapter.recognize(a,{}),!r)throw new Error("PDF OCR error");return await this._processOcrResult(t,e,null,r,18)}}class T{constructor(t,e,n){this.ocrEngine=t,this.translatorService=e,this.ocrType=n}getOcrEngine(){return this.ocrEngine}setOcrEngine(t){this.ocrEngine=t}getTranslatorService(){return this.translatorService}setTranslatorService(t){this.translatorService=t}async processContent(t,e=null){let n,o=e;if(o||(o=this.ocrType),"image"===o||"page"===o)n=new O(this.ocrEngine,this.translatorService);else{if("pdf"!==o)throw new Error(`OCR Type not supported: ${o}`);n=new B(this.ocrEngine,this.translatorService)}return await n.process(t)}}class M{constructor(t,e,n){this.uiManager=e,this.translationService=t,this.total=0,this.processed=0,this.batchNodes=[],this.individualNodes=[],this.DELIMITER=n.delimiter||"[[BR]]",this.BATCH_MAX_LENGTH=n.batchMaxLength||1e3,this.NODE_DELIMITER=n.nodeDelimiter||"[[ND]]"}processPageState(t){d.storeOriginalTextNodes();const e=d.getTextNodes(document.body),n=e.length;e.forEach((t=>{if((!t.parentElement||!t.parentElement.classList.contains("translation-wrapper"))&&t.parentNode){const e=document.createElement("span");if(e.className="translation-wrapper",t.parentNode.insertBefore(e,t),e.appendChild(t),!e.querySelector(".text-spinner")){let t=document.createElement("span");t.className="text-spinner",e.appendChild(t)}}}));const o=[],a=[];for(const t of e)t.nodeValue.length>this.BATCH_MAX_LENGTH?a.push(t):o.push(t);return this.total=n,this.batchNodes=o,this.individualNodes=a,n}updateProgress(){this.processed+=1,this.uiManager.updateFeedback(`(${this.processed}/${this.total})`)}static removeSpinner(t){if(t){let e=t.querySelector(".text-spinner");e&&t.removeChild(e)}}static addRetryButton(t,e,n){if(!t)return;let o=document.createElement("button");o.className="text-retry-button",o.textContent="↻",o.onclick=async function(){t.contains(o)&&t.removeChild(o);let a=document.createElement("span");a.className="text-spinner",t.appendChild(a);try{const o=await n(e.nodeValue);e.nodeValue=o,t.contains(a)&&t.removeChild(a)}catch(e){t.contains(a)&&t.removeChild(a),t.appendChild(o)}},t.appendChild(o)}static removeRetryButton(t){if(t){let e=t.querySelector(".text-retry-button");e&&t.removeChild(e)}}async processPageNodes(){await Promise.all([this.processBatchNodes(),this.processIndividualNodes()]),d.storeOriginalTextNodes()}async processBatchNodes(){if(this.batchNodes.length>0)try{await this.translateNodesBatch()}catch(t){await this.translateNodesIndividually()}}async translateNodesIndividually(){for(const t of this.batchNodes){await d.checkPaused();let e=t.parentElement;if(e){try{let n=await this.translationService.translateText(t.nodeValue);t.nodeValue=n,M.removeSpinner(e)}catch(n){M.removeSpinner(e),M.addRetryButton(e,t,this.translationService?.translateText?.bind(this.translationService))}this.updateProgress()}}}async translateNodesBatch(){let t=[],e=[],n=0;for(const o of this.batchNodes){const a=o.nodeValue;n+a.length>this.BATCH_MAX_LENGTH&&e.length>0&&(t.push([...e]),e=[],n=0),e.push(o),n+=a.length}e.length>0&&t.push([...e]);for(const e of t)await this.translateBatchRecursively(e)}async translateBatchRecursively(t){await d.checkPaused();const e=t.map((t=>t.nodeValue)).join(this.NODE_DELIMITER);let n;try{n=await this.translationService.translateText(e)}catch(e){if(1===t.length){let e=t[0],n=e.parentElement;if(!n)return;try{let t=await this.translationService.translateText(e.nodeValue);return e.nodeValue=t,M.removeSpinner(n),void this.updateProgress()}catch(t){return M.removeSpinner(n),void M.addRetryButton(n,e,this.translationService?.translateText?.bind(this.translationService))}}const n=Math.floor(t.length/2);return await this.translateBatchRecursively(t.slice(0,n)),void await this.translateBatchRecursively(t.slice(n))}let o=n.split(/(?:(?:\|[ \t\r\n]*){0,4}A[ \t\r\n]*I[ \t\r\n]*L[ \t\r\n]*E[ \t\r\n]*N[ \t\r\n]*S(?:[ \t\r\n]*\|){0,4}|(?:\|[ \t\r\n]*){1,3}d?(?:[ \t\r\n]*\|){1,3})/gi);if(o.length!==t.length&&(o=o.filter(((t,e,n)=>0===e||d.normalize(t)!==d.normalize(n[e-1])))),o.length!==t.length){if(1===t.length){let e=t[0],n=e.parentElement;if(!n)return;n.querySelector(".text-spinner");try{let t=await(this.translationService?.translateText(e.nodeValue));return e.nodeValue=t,M.removeSpinner(n),void this.updateProgress()}catch(t){return M.removeSpinner(n),void M.addRetryButton(n,e,this.translationService?.translateText?.bind(this.translationService))}}const e=Math.floor(t.length/2);return await this.translateBatchRecursively(t.slice(0,e)),void await this.translateBatchRecursively(t.slice(e))}for(let e=0;e<t.length;e++){await d.checkPaused();let n=t[e].parentElement;M.removeSpinner(n),M.removeRetryButton(n),t[e].nodeValue=d.decodeHTMLEntities(o[e]),this.updateProgress()}}async processIndividualNodes(){for(const t of this.individualNodes)await d.checkPaused(),await this.translateSingleNode(t)}async translateSingleNode(t){let e=t.parentElement;try{const n=await(this.translationService?.translateText(t.nodeValue));t.nodeValue=n,this.updateProgress(),M.removeSpinner(e)}catch(n){M.removeSpinner(e),M.addRetryButton(e,t,this.translationService?.translateText?.bind(this.translationService))}}}class P{constructor(t){this.uiManager=k.createUIManager(t.uiType),this.translationService=new y(t.translatorOptions,t.translator,t.queueDelay,t?.worker),this.translationService.initWorker(),this.core=new M(this.translationService,this.uiManager,t.coreSettings),this.ocrManager=new T(t.ocrWorker,this.translationService,t.uiType)}async translatePage(){try{this.uiManager.initUI();const t=this.core.processPageState(document.body);this.uiManager.updateFeedback(`(0/${t})`,!0),await this.core.processPageNodes()}catch(t){w.showNotification(`${t}`,"error")}}async translateImages(){try{this.uiManager.initUI();const t=document.querySelectorAll("img"),e=t.length;await this.ocrManager.getOcrEngine().initEngine();const n=[];let o=0;return t.forEach(((t,a)=>{"true"!==t.dataset.ocrProcessed&&n.push(Promise.race([(async()=>this.ocrManager.processContent(t).then((()=>{o++,this.uiManager.updateFeedback(`Image (${o}/${e})`)})).catch((async t=>(await d.checkPaused(),Promise.resolve()))))(),new Promise(((t,e)=>{const n=setInterval((async()=>{d.isCancelled()&&(clearInterval(n),await this.ocrManager.getOcrEngine().terminateEngine(),e(new Error("Operation cancelled.")))}),50)}))]))})),await Promise.all(n),await this.ocrManager.getOcrEngine().terminateEngine(),0}catch(t){return w.showNotification(`${t}`,"error"),1}}async translateLocalImages(){try{this.uiManager.initUI(),this.uiManager.updateFeedback("(0/1)",!0),await this.translateImages(),this.uiManager.updateFeedback("Done (1/1)",!0)}catch(t){w.showNotification(`${t}`,"error")}}async translatePdf(){try{const t=await import("https://cdn.jsdelivr.net/npm/pdfjs-dist@5.0.375/+esm");window.pdfjsLib=t,pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/5.0.375/pdf.worker.mjs",this.uiManager.initUI();const e=atob(base64Data.data);base64Data.data="",delete base64Data.data;if(!document.getElementById("pdf-container"))throw new Error("Elemento con id 'pdf-container' non trovato.");const n=await pdfjsLib.getDocument({data:e}).promise;let o=n.numPages;this.uiManager.updateFeedback(`(0/${o})`,!0);let a=await this.uiManager.createPdfPages(n);if(a.length!==o)throw new Error("Errore nella creazione delle pagine PDF.");let r=0;Math.max(1,navigator.hardwareConcurrency-1);await this.ocrManager.getOcrEngine().initEngine();for(let t=0;t<a.length;t++){await d.checkPaused();const e=a[t].querySelector("canvas");try{await this.ocrManager.processContent(e),r++,this.uiManager.updateFeedback(`(${r}/${o})`)}catch(e){r++,this.uiManager.updateFeedback(`Error on page ${t+1}`)}await d.yieldControl()}await this.ocrManager.getOcrEngine().terminateEngine(),this.uiManager.updateFeedback("Done!",!1)}catch(t){w.showNotification(`${t}`,"error")}}async stop(t=0){this.uiManager.removeUI(t);let e=!0;for(;e;){e=!1;document.querySelectorAll(".ocr-box").forEach((t=>{"[[ERROR]]"===JSON.parse(t.getAttribute("data-ocr-info")).translatedText&&(e=!0)})),await new Promise((t=>setTimeout(t,5e3)))}this.translationService.stopWorker()}}async function z(t){return"Microsoft"===t.translator&&""===t.translatorOptions.apiKey&&(t.translatorOptions.apiKey=await async function e(){const t={method:"GET"};try{const e=await fetch("https://edge.microsoft.com/translate/auth",t);if(!e.ok)throw new Error("Couldn't get API key! Status: "+e.status);return await e.text()}catch(t){throw t}}()),t}class N{constructor(){this.options={coreSettings:{},translator:null,translatorOptions:{},queueDelay:0,ocrEngine:null}}setCoreSettings(t="||d||",e=1e3,n="|||AILENS|||"){return this.options.coreSettings={delimiter:t,batchMaxLength:e,nodeDelimiter:n},this}setTranslator(t){return this.options.translator=t,this}setTranslatorOptions(t){return this.options.translatorOptions=t,this}setQueueDelay(t){return this.options.queueDelay=t,this}setOCREngine(t,e=Tesseract.PSM.AUTO_OSD){return this.options.ocrEngine=new I(t,{tessedit_pageseg_mode:e}),this}customize(t){return"fast"===t&&(this.options.coreSettings.batchMaxLength=500,this.options.queueDelay=500),this}build(){return this.options}}const L="undefined"!=typeof window?window:"undefined"!=typeof self?self:globalThis;L.immTrans=L.immTrans||{},L.immTrans.start=async function F(n="page",o,a,r={}){t=o,e=a;let i=(new N).setCoreSettings().setTranslator(r?.translator).setTranslatorOptions(r?.translatorOptions).setQueueDelay(r?.queueDelay).setOCREngine(r?.ocrLanguages).build();try{i=await z(i)}catch(t){return}await immTrans.ready;const s=new P({translator:i.translator,translatorOptions:i.translatorOptions,queueDelay:i.queueDelay,ocrWorker:i.ocrEngine,uiType:n,coreSettings:i.coreSettings,worker:immTrans?.worker});switch(n){case"page":!function l(){const t=document.createElement("style");t.textContent="\n        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}@keyframes fadein{from{opacity:0!important;transform:translateY(-15px)}to{opacity:1!important;transform:translateY(0)}}@keyframes fadeout{from{opacity:1}to{opacity:0}}#translationContainer{position:fixed!important;bottom:20px!important;right:20px!important;display:flex!important;flex-direction:row!important;align-items:center!important;gap:8px!important;z-index:10000000!important;transition:transform .3s ease-in-out!important;transform-origin:right!important}#translationContainer.hidden{transform:translateX(68%)}#translationFeedbackBox{background:linear-gradient(135deg,rgba(44,62,80,.95),rgba(52,73,94,.85))!important;color:#fff!important;padding:16px 24px!important;border-radius:10px!important;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif!important;font-size:16px!important;display:flex!important;max-width:90vw!important;align-items:center!important;box-shadow:0 6px 16px rgba(0,0,0,.35)!important;backdrop-filter:blur(6px)!important;transition:transform .3s ease-in-out!important;transform-origin:right!important}.immTransl-arrow{width:24px;height:24px;cursor:pointer;transition:transform .3s ease;margin-right:12px;align-items:center;display:flex}#translationContainer.hidden .immTransl-arrow{transform:rotate(180deg)}#translationFeedbackBox .spinner{width:24px!important;height:24px!important;border:3px solid #fff!important;border-top:3px solid transparent!important;border-radius:50%!important;margin-right:12px!important;animation:spin 1s linear infinite}#notificationContainer{position:fixed!important;bottom:90px!important;right:20px!important;z-index:11000!important;display:flex!important;flex-direction:column!important;gap:10px!important;max-width:90vw!important}.notification{padding:12px 20px!important;border-radius:8px!important;color:#fff!important;font-family:Arial,sans-serif!important;font-size:16px!important;box-shadow:0 4px 12px rgba(0,0,0,.2)!important;animation:fadein .5s ease-out!important}.notification.error{background-color:#e74c3c!important}.notification.warning{background-color:#f1c40f!important;color:#000!important}.notification.success{background-color:#2ecc71!important;color:#000!important}.notification.info{background-color:#3498db!important;color:#fff!important}.fade-out{animation:fadeout .5s forwards!important}@media (max-width:600px){#translationFeedbackBox,.notification{font-size:14px!important;padding:10px 16px!important}#translationFeedbackBox .spinner{width:16px!important;height:16px!important;margin-right:8px!important}}#translationControls{margin-left:12px!important;display:flex!important;gap:8px!important}.immTransl-control-btn{width:36px!important;height:36px!important;border:none!important;border-radius:50%!important;cursor:pointer!important;outline:0!important;display:flex!important;align-items:center!important;justify-content:center!important;color:#fff!important;font-size:14px!important;transition:background-color .2s ease,transform .1s ease!important}.immTransl-control-btn:hover{filter:brightness(1.2)!important}.immTransl-control-btn:active{transform:scale(.95)!important}.immTransl-control-btn.pause{background-color:#f1c40f!important}.immTransl-control-btn.resume{background-color:#2ecc71!important}.immTransl-control-btn.cancel{background-color:#e74c3c!important}.immTransl-control-btn.reset{background:linear-gradient(135deg,rgba(44,62,80,.95),rgba(52,73,94,.85))!important;box-shadow:0 6px 16px rgba(0,0,0,.35)!important;backdrop-filter:blur(6px)!important;transition:background-color .3s ease,transform .1s ease!important;width:48px!important;height:48px!important}.immTransl-control-btn:disabled{opacity:.5!important;cursor:not-allowed!important}@media (max-width:600px){#translationFeedbackBox,.notification{font-size:14px!important;padding:10px 16px!important}#translationFeedbackBox .spinner{width:16px!important;height:16px!important;margin-right:8px!important}}.translation-wrapper{position:relative;align-items:center}.text-spinner{display:inline-block;width:1em;height:1em;border:3px solid rgba(0,0,0,.604);border-top:3px solid transparent;border-radius:50%;animation:spin 1s linear infinite;margin-left:5px;flex:0 0 auto}.text-retry-button{width:1em;height:1em;background-color:#e53935;color:#fff;border:none;border-radius:4px;padding:10px;display:inline-flex;align-items:center;justify-content:center;font-weight:500;text-transform:uppercase;cursor:pointer;outline:0;box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12);transition:box-shadow .3s ease,background-color .3s ease;position:absolute;cursor:pointer;z-index:1000}.text-retry-button:hover{background-color:#d32f2f;box-shadow:0 5px 5px -3px rgba(0,0,0,.2),0 8px 10px 1px rgba(0,0,0,.14),0 3px 14px 2px rgba(0,0,0,.12)}.text-retry-button:active{background-color:#c62828;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)}.text-retry-button::after{position:absolute;top:0;left:0;right:0;bottom:0;background:0 0;z-index:9999}.ocr-overlay{position:absolute!important;color:#fff!important;font-family:'Helvetica Neue',Arial,sans-serif!important;text-shadow:0 1px 2px rgba(0,0,0,.6)!important;padding:4px 8px!important;border-radius:0!important;display:flex;align-items:center!important;justify-content:center!important;z-index:9999!important;transition:opacity .3s ease!important;opacity:.95!important;overflow:hidden!important;white-space:pre-wrap!important}.ocr-box{position:absolute!important;background:linear-gradient(135deg,rgba(44,62,80,.95),rgba(52,73,94,.85));box-shadow:8px 8px 11px rgba(0,0,0,.1),0 1px 2px rgba(0,0,0,.1)!important;color:#fff;font-weight:400!important;display:flex;justify-content:center!important;align-items:center!important;flex-direction:column!important;-webkit-overflow-scrolling:touch;-webkit-backdrop-filter:blur(40px)!important;-webkit-hyphens:auto!important;line-height:1.2em!important;box-sizing:border-box!important;word-break:break-word!important;word-wrap:break-word!important;letter-spacing:normal!important;border-radius:8px!important;font-family:'Helvetica Neue',Arial,sans-serif!important;text-align:left!important;padding:2px 4px!important;overflow:auto!important;white-space:normal!important;z-index:9999!important}.ocr-box-text{font-size:100%}.ocr-box-text::-webkit-scrollbar{-webkit-appearance:none;width:0;height:0}.ocr-box::-webkit-scrollbar{-webkit-appearance:none;width:0;height:0}.ocr-box.dragging{touch-action:none;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none}#pdf-container.dragging{touch-action:none;-webkit-touch-callout:none;-webkit-user-select:none}.ocr-box.ocr-box-error{background:linear-gradient(135deg,#f8e1e1,#fdf5f5);color:#a94442;box-shadow:0 4px 8px rgba(0,0,0,.05);border-radius:8px;padding:0;overflow:hidden}.ocr-box.ocr-box-error:hover{transform:scale(1.02);box-shadow:0 8px 16px rgba(0,0,0,.2)}.ocr-box .spinner{display:inline-block;width:auto;height:1em;aspect-ratio:1;border:3px solid rgba(255,255,255,.1)!important;border-top:3px solid transparent!important;border-radius:50%!important;margin:auto!important;animation:spin 1s linear infinite}.ocr-box.ocr-box-error .ocr-retry-btn{display:flex;align-items:center;justify-content:center;width:100%;height:100%;background:#f44336;color:#fff;font-size:clamp(6px, 5vw, 24px);font-weight:500;border:none;outline:0;border-radius:4px;cursor:pointer;text-transform:uppercase;letter-spacing:.5px;position:relative;overflow:hidden;transition:background .3s,box-shadow .3s}.ocr-box.ocr-box-error .ocr-retry-btn:hover{background:#e53935;box-shadow:0 4px 8px rgba(0,0,0,.3)}.ocr-box.ocr-box-error .ocr-retry-btn:active{background:#d32f2f;box-shadow:0 2px 4px rgba(0,0,0,.2)}.ocr-box.ocr-box-error .ocr-retry-btn::after{content:\"\";position:absolute;top:50%;left:50%;width:5px;height:5px;background:rgba(255,255,255,.5);opacity:0;border-radius:50%;transform:translate(-50%,-50%) scale(1);transition:width .6s ease-out,height .6s ease-out,opacity .6s ease-out}.ocr-box.ocr-box-error .ocr-retry-btn:active::after{width:120%;height:120%;opacity:0;transition:0s}.img-container{position:relative!important;display:inline-block!important}#pdf-viewer{position:relative;width:auto;height:95%;display:flex}#pdf-toolbar{position:fixed;top:10px;left:50%;transform:translateX(-50%);width:90%;max-width:600px;height:55px;background:rgba(44,62,80,.7);backdrop-filter:blur(10px);border-radius:12px;color:#fff;display:flex;align-items:center;justify-content:space-between;z-index:1000000;box-shadow:0 4px 12px rgba(0,0,0,.2);padding:0 15px;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}#pdf-toolbar button{background:rgba(255,255,255,.2);border:none;color:#fff;padding:10px;margin:0 5px;border-radius:8px;font-size:18px;cursor:pointer;transition:all .3s ease-in-out;display:flex;align-items:center;justify-content:center;width:42px;height:42px}#pdf-toolbar button:hover{background:rgba(255,255,255,.4)}#pdf-toolbar button:disabled{opacity:.5;cursor:not-allowed}#pdf-toolbar button i{font-size:22px}#pdf-toolbar span{font-size:18px;font-weight:700;text-align:center;flex-grow:1;padding:0 10px}.PDFtextLayer span{position:absolute!important}.PDFtextLayer{position:absolute;top:0;left:0;width:100%;height:100%}#pdf-container{margin-top:80px;flex:1;display:flex;flex-direction:column;gap:15px;overflow:visible;position:relative;margin:auto;width:95%}#pdf-container .ocr-container{position:relative;width:100%;box-shadow:0 0 6px rgba(0,0,0,.2);overflow:hidden}#pdf-container canvas{width:100%!important;height:auto!important;display:block}#pdfOptionsOverlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:10000;padding:20px;animation:fadeIn .3s ease-in-out}@keyframes fadeIn{from{opacity:0}to{opacity:1}}#pdfOptionsModal{background:#f5f5f5;border-radius:8px;padding:20px;width:100%;max-width:400px;box-shadow:0 4px 12px rgba(0,0,0,.15);font-family:Arial,sans-serif;opacity:0;transform:translateY(20px);animation:slideUp .4s forwards}@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}#pdfOptionsModal h2{margin-top:0;font-size:20px;color:#333;text-align:center;margin-bottom:20px}#pdfOptionsModal form>div{margin-bottom:15px}#pdfOptionsModal label{color:#333;font-size:14px;margin-left:8px}#pdfOptionsModal input[type=number],#pdfOptionsModal input[type=text]{width:calc(100% - 20px);padding:10px;margin-top:8px;border:1px solid #ccc;border-radius:4px;font-size:14px;transition:border-color .3s ease,box-shadow .3s ease}#pdfOptionsModal input[type=number]:focus,#pdfOptionsModal input[type=text]:focus{outline:0;border-color:#333;box-shadow:0 0 5px rgba(51,51,51,.3)}#pdfOptionsModal input[type=radio]{transform:scale(1.2);vertical-align:middle;margin-right:8px}#pdfOptionsModal .quality-container{display:flex;align-items:center;justify-content:center;gap:8px}#pdfOptionsModal .quality-container label{font-size:14px;color:#333}#pdfOptionsModal .quality-container input[type=range]{flex:1;margin:0}#pdfOptionsModal .quality-container span{width:40px;text-align:center;font-size:14px;color:#333}#pdfOptionsModal input[type=range]{-webkit-appearance:none;width:100%;height:6px;border-radius:3px;background:#ddd;outline:0;transition:background .3s}#pdfOptionsModal input[type=range]::-webkit-slider-runnable-track{width:100%;height:6px;cursor:pointer;background:#ddd;border-radius:3px}#pdfOptionsModal input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:#333;cursor:pointer;transition:background .3s,transform .2s;margin-top:-7px}#pdfOptionsModal input[type=range]::-webkit-slider-thumb:hover{background:#555;transform:scale(1.1)}@media (max-width:480px){#pdfOptionsModal .quality-container{flex-direction:column;align-items:center}#pdfOptionsModal .quality-container input[type=range]{width:100%;margin:8px 0}#pdfOptionsModal .quality-container span{text-align:center}}#pdfOptionsModal .button-group{display:flex;justify-content:flex-end;gap:10px;margin-top:20px}#pdfOptionsModal button{padding:10px 18px;font-size:14px;border:none;border-radius:4px;cursor:pointer;transition:background-color .3s ease,transform .2s ease}#pdfOptionsModal button#cancelPdfOptions{background:#ccc;color:#fff}#pdfOptionsModal button#cancelPdfOptions:hover{background:#b3b3b3;transform:scale(1.02)}#pdfOptionsModal button#confirmPdfOptions{background:#333;color:#fff}#pdfOptionsModal button#confirmPdfOptions:hover{background:#1a1a1a;transform:scale(1.02)}@media (max-width:480px){#pdfOptionsModal{padding:15px;max-width:90%}#pdfOptionsModal h2{font-size:18px}#pdfOptionsModal button{padding:10px;font-size:16px}#pdfOptionsModal button#confirmPdfOptions{flex:auto}}@media (max-width:600px){#pdf-toolbar{width:95%;max-width:95%;height:60px;padding:0 10px}#pdf-toolbar button{width:44px;height:44px}#pdf-toolbar button i{font-size:20px}#pdf-toolbar span{font-size:16px}#pdf-viewer{margin-top:90px}#pdf-toolbar #pageIndicator,#pdf-toolbar #zoomIndicator{font-size:14px}}@media (max-width:480px){.ocr-box{padding:1px 2px!important;border-radius:4px!important}.ocr-overlay{padding:2px 4px!important}}\n    ",document.head.appendChild(t)}(),await Promise.all([s.translatePage(),s.translateImages()]),s.uiManager.updateFeedback("Done!",!1),s.stop(5e3);break;case"image":await s.translateLocalImages(),s.uiManager.updateFeedback("Done!",!1),s.stop(5e3);break;case"pdf":await s.translatePdf(),s.stop(5e3);break;default:throw new Error("Invalid type")}}}();